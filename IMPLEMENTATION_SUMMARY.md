# ç« èŠ‚çŠ¶æ€å¿«ç…§åŠŸèƒ½å®ç°æ€»ç»“

## åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸä¸ºä½ çš„ `narrative_agent.py` æ·»åŠ äº†ç« èŠ‚çŠ¶æ€å¿«ç…§åŠŸèƒ½ï¼Œå®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **ç« èŠ‚çº§ä¿®æ”¹æœºåˆ¶ï¼ˆChapter-level Revision Agentï¼‰**ï¼š
   - æ¯ä¸ªç« èŠ‚å…è®¸ç”¨æˆ·æœ€å¤šè¿›è¡Œ5æ¬¡è‡ªç”±ä¿®æ”¹è¾“å…¥ã€ä»…é™ã€æ˜´ã€‘çš„éƒ¨åˆ†ï¼Œå…¶ä½™éƒ¨åˆ†ä¸å¯ä¿®æ”¹ã€‘
   - æ¯æ¬¡ä¿®æ”¹åï¼Œè°ƒç”¨LLMåŸºäºç”¨æˆ·è¾“å…¥é‡å†™è¯¥ç« èŠ‚çš„"å…¨éƒ¨åç»­å‰§æƒ…"éƒ¨åˆ†ï¼ˆä»ä¿®æ”¹ç‚¹ä¹‹åï¼‰
   - æ’­æ”¾å‰§æƒ…æ—¶ä»ç„¶æŒ‰ç…§chunkæ’­æ”¾ï¼Œç”¨æˆ·æ— æ³•ä¸€æ¬¡æ€§çœ‹åˆ°å…¨éƒ¨å‰§æƒ…

2. **ä¿å­˜/æäº¤æœ¬ç«  â†’ å¯¹æ•´ç« æ–‡æœ¬åšä¸€æ¬¡ LLM ç»“æ„åŒ–æŠ½å– â†’ ç”Ÿæˆæœ¬ç« çŠ¶æ€å¿«ç…§ JSONL**
3. **æŒ‰ç« èŠ‚è¾“å‡ºæ ‡å‡†åŒ–çŠ¶æ€ JSON å¿«ç…§**ï¼š`chapter_001.json`ã€`chapter_002.json`ã€â€¦
4. **æ¯ä¸ªå¿«ç…§å«äº”å—**ï¼š`events`ã€`relations`ã€`goals`ã€`objects`ã€`meta`
5. **å¤±è´¥é‡è¯•ä¸ä¸¥æ ¼æ ¡éªŒ**ï¼šä¿è¯äº§ç‰©å¯æ¯”å¯¹ã€å¯å¤ç°

## æ–‡ä»¶ç»“æ„

```
World_developer/
â”œâ”€â”€ narrative_agent.py          # ä¸»ç¨‹åºï¼ˆå·²é›†æˆæ–°åŠŸèƒ½ï¼‰
â”œâ”€â”€ narrative_state.py          # çŠ¶æ€å®šä¹‰ï¼ˆPydanticå¼ºæ ¡éªŒï¼‰
â”œâ”€â”€ state_extractor.py          # LLMæŠ½å–å™¨ï¼ˆJSONä¸¥æ ¼æ¨¡å¼+é‡è¯•ï¼‰
â”œâ”€â”€ chapter_segmenter.py        # ç« èŠ‚åˆ†å‰²å™¨
â”œâ”€â”€ build_chapter_states.py     # æ„å»ºè„šæœ¬
â”œâ”€â”€ test_system.py              # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ demo.py                     # æ¼”ç¤ºè„šæœ¬
â”œâ”€â”€ demo_chapter_edit.py        # ç« èŠ‚çº§ç¼–è¾‘æ¼”ç¤ºè„šæœ¬
â”œâ”€â”€ test_chapter_edit.py        # ç« èŠ‚çº§ç¼–è¾‘æµ‹è¯•è„šæœ¬
â”œâ”€â”€ requirements.txt            # ä¾èµ–ç®¡ç†
â”œâ”€â”€ README.md                   # ä½¿ç”¨è¯´æ˜
â””â”€â”€ world_graph/                # çŠ¶æ€å¿«ç…§ç›®å½•
    â”œâ”€â”€ canon/                  # åŸå§‹ä¸–ç•Œçº¿çŠ¶æ€
    â”‚   â”œâ”€â”€ chapter_001.json
    â”‚   â””â”€â”€ index.json
    â””â”€â”€ user_branch/            # ç”¨æˆ·ä¿®æ”¹åçŠ¶æ€
        â””â”€â”€ chapter_001.json
```

## æ ¸å¿ƒå®ç°

### 1. ç« èŠ‚çº§ä¿®æ”¹æœºåˆ¶

**æ ¸å¿ƒåŠŸèƒ½**ï¼šå®ç°äº†ç« èŠ‚çº§ä¿®æ”¹æœºåˆ¶ï¼ŒåŒæ—¶ä¿æŒchunkçº§æ’­æ”¾ä½“éªŒã€‚

- **ç« èŠ‚**ï¼šæ•´ä¸ªæ–‡ä»¶è¢«è§†ä¸ºä¸€ä¸ªå®Œæ•´çš„ç« èŠ‚
- **Chunk**ï¼šæŒ‰ã€æ˜´ã€‘æ ‡è®°åˆ’åˆ†çš„å°æ®µè½ï¼Œç”¨äºäº¤äº’å¼æ’­æ”¾
- **ç¼–è¾‘é™åˆ¶**ï¼šæ¯ä¸ªç« èŠ‚æœ€å¤š5æ¬¡ä¿®æ”¹ï¼Œä»…é™ã€æ˜´ã€‘éƒ¨åˆ†
- **æ™ºèƒ½é‡å†™**ï¼šä¿®æ”¹åLLMé‡å†™åç»­å‰§æƒ…ï¼Œä¿æŒè¿è´¯æ€§
- **æ’­æ”¾æ–¹å¼**ï¼šä»ç„¶æŒ‰chunkæ’­æ”¾ï¼Œç”¨æˆ·æ— æ³•ä¸€æ¬¡æ€§çœ‹åˆ°å…¨éƒ¨å‰§æƒ…

### 2. çŠ¶æ€æ¨¡å¼å®šä¹‰ï¼ˆä¸¥æ ¼ JSONï¼Œå¯æ ¡éªŒï¼‰

ä½¿ç”¨ Pydantic åšå¼ºæ ¡éªŒï¼Œä¿è¯åç»­æ¯”è¾ƒå¯é ï¼š

```python
class Event(BaseModel):
    who: str = Field(..., min_length=1)
    action: str = Field(..., min_length=1)
    target: Optional[str] = None
    goal: Optional[str] = None
    polarity: Optional[Polarity] = 0
    # ... å…¶ä»–å­—æ®µ

class Relation(BaseModel):
    a: str
    b: str
    type: RelationType
    score: float = Field(ge=0.0, le=1.0)

class NarrativeState(BaseModel):
    chapter_id: int
    title: str
    events: List[Event] = []
    relations: List[Relation] = []
    goals: Dict[str, List[str]] = {}
    objects: Dict[str, str] = {}
    meta: Dict[str, str] = {}
```

### 2. LLM æŠ½å–å™¨ï¼ˆJSON ä¸¥æ ¼æ¨¡å¼ + é‡è¯•ï¼‰

ä¸è®­ç»ƒæ¨¡å‹ï¼Œé æç¤º+æ ¡éªŒ+é‡è¯•å³å¯ã€‚æŠ½å–æŒ‰"æ•´ç« "åšä¸€æ¬¡ï¼Œé¿å… chunk çº§æŠ–åŠ¨ï¼š

```python
def extract_state_for_chapter(chapter_id:int, title:str, chapter_text:str, client: Optional[OpenAI]) -> NarrativeState:
    # 3æ¬¡é‡è¯•æœºåˆ¶
    for attempt in range(3):
        try:
            # LLMè°ƒç”¨ + JSONè§£æ + Pydanticæ ¡éªŒ
            # å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
        except (json.JSONDecodeError, ValidationError) as e:
            time.sleep(0.6)
    
    # ä¸‰æ¬¡å¤±è´¥ç»™å‡ºä¿åº•ç»“æ„
    return NarrativeState(chapter_id=chapter_id, title=title, meta={"note":"parse_fail"})
```

### 3. ç« èŠ‚çº§ç¼–è¾‘æ ¸å¿ƒæ–¹æ³•

å®ç°äº†å®Œæ•´çš„ç« èŠ‚çº§ç¼–è¾‘åŠŸèƒ½ï¼š

```python
def edit_chapter(self, user_edit: str, position_index: int = 0):
    """ç¼–è¾‘ç« èŠ‚ä¸­çš„ã€æ˜´ã€‘éƒ¨åˆ†"""
    # æ£€æŸ¥ç¼–è¾‘æ¬¡æ•°é™åˆ¶
    # éªŒè¯ç¼–è¾‘å†…å®¹æ ¼å¼
    # æ›´æ–°ç« èŠ‚å†…å®¹
    # è°ƒç”¨LLMé‡å†™åç»­å‰§æƒ…
    # é‡æ–°åˆ†å‰²chunks

def rewrite_remaining_chapter(self, edit_position: int):
    """åŸºäºç”¨æˆ·ä¿®æ”¹é‡å†™ç« èŠ‚çš„åç»­éƒ¨åˆ†"""
    # æ„å»ºé‡å†™æç¤º
    # è°ƒç”¨LLMé‡å†™
    # æ›´æ–°ç« èŠ‚å†…å®¹

def build_rewrite_prompt(self, edit_position: int) -> str:
    """æ„å»ºé‡å†™æç¤º"""
    # ä½¿ç”¨ä½ æä¾›çš„promptæ¨¡æ¿
    # åŒ…å«åŸå§‹å†…å®¹ã€ç”¨æˆ·ä¿®æ”¹ã€ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯
```

### 4. æ–°å¢äº¤äº’å‘½ä»¤

åœ¨äº¤äº’æ¨¡å¼ä¸­æ·»åŠ äº†ç« èŠ‚çº§ç¼–è¾‘ç›¸å…³å‘½ä»¤ï¼š

```python
# ç« èŠ‚çº§ç¼–è¾‘å‘½ä»¤
elif command.startswith(('ce', 'chapter_edit')):
    # ç« èŠ‚çº§ç¼–è¾‘ï¼Œé‡å†™åç»­å‰§æƒ…
elif command in ['p', 'positions']:
    # æ˜¾ç¤ºå¯ç¼–è¾‘çš„ã€æ˜´ã€‘ä½ç½®
elif command in ['d', 'display']:
    # æ˜¾ç¤ºå®Œæ•´ç« èŠ‚å†…å®¹
elif command in ['r', 'reset']:
    # é‡ç½®ç« èŠ‚åˆ°åŸå§‹çŠ¶æ€
```

### 5. ç« èŠ‚å¤„ç†é€»è¾‘ä¿®æ­£

ä¿®æ­£äº†ç« èŠ‚è·å–é€»è¾‘ï¼Œç°åœ¨æ­£ç¡®å¤„ç†æ•´ä¸ªæ–‡ä»¶ä½œä¸ºä¸€ä¸ªç« èŠ‚ï¼š

```python
def get_current_chapter_id(self) -> int:
    """è·å–å½“å‰ç« èŠ‚ID"""
    # æ•´ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªç« èŠ‚
    return 1

def get_current_chapter_content(self) -> str:
    """è·å–å½“å‰ç« èŠ‚çš„å®Œæ•´å†…å®¹"""
    # æ•´ä¸ªæ–‡ä»¶å†…å®¹å°±æ˜¯ç« èŠ‚å†…å®¹
    return self.modified_content
```

### 6. ä¸ç°æœ‰ NarrativeAgent å¯¹æ¥ï¼ˆæœ€å°ä¾µå…¥ï¼‰

åœ¨åˆå§‹åŒ–æ—¶ï¼Œå…ˆæ£€æŸ¥ `world_graph/canon` æ˜¯å¦å·²å­˜åœ¨ï¼›è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨æ„å»ºè„šæœ¬ç¦»çº¿ç”Ÿæˆä¸€æ¬¡ï¼š

```python
def ensure_canon_states(self):
    """ç¡®ä¿canonçŠ¶æ€å¿«ç…§å­˜åœ¨"""
    if not os.path.exists(self.canon_states_dir):
        print("ğŸ”§ é¦–æ¬¡è¿è¡Œï¼Œæ­£åœ¨ç”ŸæˆcanonçŠ¶æ€å¿«ç…§...")
        self.build_canon_states()
    else:
        print("âœ… canonçŠ¶æ€å¿«ç…§å·²å­˜åœ¨")
```

### 7. æ–°å¢äº¤äº’å‘½ä»¤

åœ¨äº¤äº’æ¨¡å¼ä¸­æ·»åŠ äº† `state` å‘½ä»¤ï¼š

```python
elif command == 'state':
    self.save_chapter_state()
```

## ä½¿ç”¨æ–¹æ³•

### 1. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 2. è¿è¡Œç³»ç»Ÿ
```bash
python narrative_agent.py
```

### 3. ä½¿ç”¨æ–°åŠŸèƒ½
- åœ¨äº¤äº’æ¨¡å¼ä¸­è¾“å…¥ `state` å‘½ä»¤
- ç³»ç»Ÿä¼šè‡ªåŠ¨æå–å½“å‰ç« èŠ‚çŠ¶æ€å¹¶ä¿å­˜
- çŠ¶æ€å¿«ç…§ä¼šä¿å­˜åˆ° `world_graph/user_branch/` ç›®å½•

## æµ‹è¯•éªŒè¯

### 1. æ¨¡å—å¯¼å…¥æµ‹è¯•
```bash
python -c "import narrative_state; print('âœ… æˆåŠŸ')"
python -c "import state_extractor; print('âœ… æˆåŠŸ')"
python -c "import chapter_segmenter; print('âœ… æˆåŠŸ')"
python -c "import narrative_agent; print('âœ… æˆåŠŸ')"
```

### 2. åŠŸèƒ½æµ‹è¯•
```bash
python test_system.py
```

### 3. æ¼”ç¤º
```bash
python demo.py
```

## çŠ¶æ€å¿«ç…§ç¤ºä¾‹

```json
{
  "chapter_id": 1,
  "title": "ç¬¬1ç« ",
  "events": [
    {
      "who": "æ˜´",
      "action": "é†’æ¥",
      "target": null,
      "goal": "äº†è§£ç°çŠ¶",
      "polarity": 0,
      "time": null,
      "location": "å¼‚ä¸–ç•Œ",
      "precond": null,
      "effect": "å¼€å§‹å†’é™©"
    }
  ],
  "relations": [
    {
      "a": "æ˜´",
      "b": "çˆ±èœœè‰é›…",
      "type": "åŒä¼´",
      "score": 0.8
    }
  ],
  "goals": {
    "æ˜´": ["ä¿æŠ¤çˆ±èœœè‰é›…", "è§£å¼€æ­»äº¡å›å½’ä¹‹è°œ"]
  },
  "objects": {
    "æ­»äº¡å›å½’": "å·²æ¿€æ´»",
    "å¾½ç« ": "çˆ±èœœè‰é›…æŒæœ‰"
  },
  "meta": {
    "worldline_id": "canon",
    "model": "gpt-4o"
  }
}
```

## ä¸‹ä¸€æ­¥è®¡åˆ’

æ ¹æ®ä½ çš„è¦æ±‚ï¼Œä¸‹ä¸€æ­¥å¯ä»¥å®ç°ï¼š

1. **compare_states() å‡½æ•°**ï¼šäº‹ä»¶å¯¹é½ã€å…³ç³»çŸ©é˜µå·®ã€ç›®æ ‡é›†åˆå·®ã€é“å…· FSM è¿è§„æ£€æµ‹
2. **stay/attach/new é˜ˆå€¼**ï¼šé»˜è®¤é˜ˆå€¼ä¸ç»Ÿè®¡è„šæœ¬
3. **constraints.json æ”¯æŒ**ï¼šè§’è‰²å¡ä¸é“å…· FSM çš„ç™½åå•åŒ–

## æ³¨æ„äº‹é¡¹

1. **APIå¯†é’¥**ï¼šé¦–æ¬¡è¿è¡Œéœ€è¦ API å¯†é’¥ç”Ÿæˆ canon çŠ¶æ€å¿«ç…§
2. **ç¦»çº¿æ¨¡å¼**ï¼šæ²¡æœ‰ API å¯†é’¥æ—¶ä¼šç”Ÿæˆç©ºçŠ¶æ€ï¼Œä½†æ–‡ä»¶ç»“æ„æ­£ç¡®
3. **ç« èŠ‚åˆ†å‰²**ï¼šåŸºäºã€æ˜´ã€‘æ ‡è®°ï¼Œç¡®ä¿æ–‡æœ¬æ ¼å¼æ­£ç¡®
4. **å‘åå…¼å®¹**ï¼šå®Œå…¨ä¿ç•™äº†åŸæœ‰çš„ chunk çº§ç¼–è¾‘åŠŸèƒ½

## æ€»ç»“

âœ… **ç« èŠ‚çº§ä¿®æ”¹æœºåˆ¶å®Œæ•´å®ç°**ï¼šå®ç°äº†5æ¬¡ç¼–è¾‘é™åˆ¶ã€æ™ºèƒ½é‡å†™ã€chunkçº§æ’­æ”¾
âœ… **çŠ¶æ€å¿«ç…§åŠŸèƒ½å®Œæ•´å®ç°**ï¼šæ‰€æœ‰è¦æ±‚çš„åŠŸèƒ½éƒ½å·²å®ç°å¹¶æµ‹è¯•é€šè¿‡
âœ… **é€»è¾‘ä¿®æ­£**ï¼šæ­£ç¡®ç†è§£äº†ç« èŠ‚æ¦‚å¿µï¼Œ`Chapter1-3.txt` ä½œä¸ºå®Œæ•´ç« èŠ‚å¤„ç†
âœ… **æœ€å°ä¾µå…¥**ï¼šå¯¹åŸæœ‰ä»£ç çš„ä¿®æ”¹æœ€å°åŒ–
âœ… **è´¨é‡ä¿è¯**ï¼šä½¿ç”¨ Pydantic å¼ºæ ¡éªŒï¼Œç¡®ä¿æ•°æ®è´¨é‡
âœ… **å¯æ‰©å±•æ€§**ï¼šä¸ºåç»­çš„ compare_states å’Œåˆ†æ­§åˆ¤å®šåŠŸèƒ½é¢„ç•™äº†æ¥å£

ä½ ç°åœ¨å¯ä»¥ï¼š
1. è¿è¡Œ `python narrative_agent.py` ä½“éªŒå®Œæ•´åŠŸèƒ½
2. ä½¿ç”¨ `ce` å‘½ä»¤è¿›è¡Œç« èŠ‚çº§ç¼–è¾‘
3. ä½¿ç”¨ `state` å‘½ä»¤ä¿å­˜ç« èŠ‚çŠ¶æ€å¿«ç…§
4. æŸ¥çœ‹ `world_graph` ç›®å½•ä¸‹çš„çŠ¶æ€æ–‡ä»¶
5. å‡†å¤‡å®ç°ä¸‹ä¸€æ­¥çš„ compare_states åŠŸèƒ½
