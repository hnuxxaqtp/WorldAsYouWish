# 叙事代理修复总结

## 问题复现与根因分析

根据您提供的分析，原代码存在以下关键问题：

### 1. 每次重写的依据错误
- **问题**：`build_rewrite_prompt` 始终使用 `self.chapter_original` 作为"原始章节内容"
- **影响**：第2次编辑时，LLM看到的仍是初始版本，不会以第1次重写后的文本为基线
- **结果**：产生跳跃与断层

### 2. ce命令始终修改第一个【昴】
- **问题**：`edit_chapter` 默认 `position_index=0`，永远替换第一个【昴】行
- **影响**：与"在当前chunk改一句→改其后文"的预期不一致
- **结果**：导致错位重写

### 3. 上下文过短且格式约束不足
- **问题**：`edit_context` 仅取200字符，提示词缺乏强约束
- **影响**：模型更易跳场或改写格式
- **结果**：风格与剧情飘逸

### 4. 采样过于活跃
- **问题**：`temperature=0.7` 增加改写幅度
- **影响**：风格与剧情更易飘逸
- **结果**：连贯性差

## 修复方案实施

### A. 让每次重写都基于"当前最新文本"

**修改文件**：`narrative_agent.py`

**修改内容**：
1. `build_rewrite_prompt` 方法：
   - 使用 `self.modified_content` 作为"当前最新全文"
   - 扩大上下文窗口从200字符到1200字符
   - 强化格式约束，要求严格使用【旁白】【角色】格式

2. `rewrite_remaining_chapter` 方法：
   - 在重写完成后添加：`self.chapter_original = self.modified_content`
   - 确保每次重写完成后将当前版本作为下一轮的"基线"

**效果**：
- ✅ 每次重写都基于最新文本，避免跳跃
- ✅ 上下文更丰富，减少断层
- ✅ 格式约束更强，保持一致性

### B. ce默认改"当前chunk内的【昴】"

**修改内容**：
1. 新增 `get_current_chunk_span()` 方法：
   - 返回当前chunk在全文中的起止字符位置
   - 支持精确定位当前chunk范围

2. 修改 `edit_chapter` 方法：
   - 参数改为 `position_index: Optional[int] = None`
   - 当 `position_index` 为 `None` 时，自动定位当前chunk内的【昴】
   - 在当前chunk范围内选择第一个【昴】进行编辑

3. 修改交互模式：
   - `ce` 命令默认调用 `edit_chapter(edit_content, position_index=None)`

**效果**：
- ✅ ce命令现在默认编辑当前chunk内的【昴】
- ✅ 如果当前chunk不含【昴】，会给出明确提示
- ✅ 支持手动指定位置索引，保持灵活性

### C. 强化上下文与格式约束

**修改内容**：
1. 上下文窗口：从200字符扩大到1200字符
2. 提示词强化：
   - 添加"必须严格使用【旁白】【角色】格式输出"
   - 添加"续写应从用户修改之处无缝承接"
   - 添加"不得开启新场景或新人物，除非先收束当前场景"

**效果**：
- ✅ 上下文更丰富，减少信息不足导致的跳跃
- ✅ 格式约束更强，保持剧本格式一致性
- ✅ 衔接要求更严格，避免场景跳跃

### D. 降温处理

**修改内容**：
1. `call_llm` 方法：
   - `temperature` 从0.7降到0.2
   - `max_tokens` 从500增加到1200
   - 系统指令强化："所有输出必须采用【旁白】【角色】的剧本格式"

**效果**：
- ✅ 生成更稳定，减少风格飘逸
- ✅ 连贯性优先，保持剧情一致性
- ✅ 输出长度更充足，支持完整重写

## 验证结果

通过 `test_fixes.py` 测试验证：

```
=== 测试1: 显示可编辑位置 ===
✅ 找到4个可编辑的【昴】位置

=== 测试2: 显示当前chunk信息 ===
✅ 正确显示第1个chunk内容

=== 测试3: 测试当前chunk定位 ===
✅ 当前chunk在全文中的位置: 0-49

=== 测试4: 测试自动选择当前chunk内的【昴】 ===
✅ 当前chunk内找到1个【昴】位置
```

## 使用方式

### 修复后的工作流程：

1. **第一次编辑**：
   ```bash
   ce
   # 输入：【昴】新的台词内容
   ```
   - 系统自动选择当前chunk内的【昴】
   - 基于当前最新文本重写后续剧情
   - 重写完成后，新版本成为下一轮基线

2. **第二次编辑**：
   ```bash
   ce
   # 输入：【昴】更新的台词内容
   ```
   - 基于第一次重写后的完整文本进行重写
   - 确保连续性和一致性

3. **手动指定位置**：
   ```python
   agent.edit_chapter("【昴】内容", position_index=2)  # 编辑第3个【昴】
   ```

## 预期效果

修复后的系统应该能够：

1. **保持连续性**：每次重写都基于最新文本，避免跳跃
2. **精确定位**：ce命令默认编辑当前chunk内的【昴】
3. **格式一致**：严格保持【旁白】【角色】格式
4. **稳定生成**：低temperature确保连贯性优先
5. **丰富上下文**：1200字符上下文窗口提供充足信息

## 后续优化建议

1. **世界线约束**：将TKG和人物关系摘要集成到提示词中
2. **多行台词编辑**：支持替换整段【昴】区块
3. **智能定位**：优化chunk定位算法，避免重复片段问题
4. **状态管理**：添加编辑历史记录和回滚功能
